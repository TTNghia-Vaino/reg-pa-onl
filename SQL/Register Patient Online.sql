CREATE DATABASE RegisterPatientOnline;
USE RegisterPatientOnline;

-- Tạo bảng Tài Khoản
CREATE TABLE TAI_KHOAN (
    MA_TK INT PRIMARY KEY IDENTITY(1,1),
    TEN_DANG_NHAP NVARCHAR(50) NOT NULL UNIQUE,
    MAT_KHAU NVARCHAR(255) NOT NULL,
    ROLE INT NOT NULL                      -- Vai trò (0: Bệnh Nhân, 1: Quản Lý, 2: Bác Sĩ)
);

-- Tạo bảng Quản Lý
CREATE TABLE QUAN_LY (
    MA_QL INT PRIMARY KEY IDENTITY(1,1),
    MA_TK INT UNIQUE,
    TEN_QL NVARCHAR(100) NOT NULL,
    SDT NVARCHAR(15),
    EMAIL NVARCHAR(100),
    FOREIGN KEY (MA_TK) REFERENCES TAI_KHOAN(MA_TK) ON DELETE CASCADE
);

-- Tạo bảng Bảo Hiểm Y Tế
CREATE TABLE BAO_HIEM_Y_TE (
    MA_BHYT NVARCHAR(15) PRIMARY KEY,
    GIOI_TINH INT NOT NULL,
    NGAY_BD DATE NOT NULL,
    NGAY_HH DATE NOT NULL,
    NGAY_SINH DATE NOT NULL
);

-- Tạo bảng Bệnh Nhân
CREATE TABLE BENH_NHAN (
    MA_BN NVARCHAR(100) PRIMARY KEY,
    MA_TK INT UNIQUE,
    HOTEN NVARCHAR(255) NOT NULL,
    SDT NVARCHAR(15),
    EMAIL NVARCHAR(100),
    DIA_CHI NVARCHAR(255),
    CCCD NVARCHAR(15),
    MA_BHYT NVARCHAR(15) UNIQUE,
    FOREIGN KEY (MA_TK) REFERENCES TAI_KHOAN(MA_TK) ON DELETE CASCADE,
    FOREIGN KEY (MA_BHYT) REFERENCES BAO_HIEM_Y_TE(MA_BHYT) ON DELETE SET NULL
);

-- Tạo bảng Tin Tức
CREATE TABLE TIN_TUC (
    MA_TIN_TUC INT PRIMARY KEY IDENTITY(1,1),
    NOI_DUNG TEXT NOT NULL,
    NGAY_DANG DATE DEFAULT GETDATE()
);

-- Tạo bảng Khoa Khám Bệnh
CREATE TABLE KHOA_KHAM_BENH (
    MA_KHOA NVARCHAR(10) PRIMARY KEY,
    TEN_KHOA NVARCHAR(100) NOT NULL
);

-- Tạo bảng Bác Sĩ
CREATE TABLE BAC_SI (
    MA_BS NVARCHAR(100) PRIMARY KEY,
    TEN NVARCHAR(50) NOT NULL,
    MA_TK INT UNIQUE,
    MA_KHOA NVARCHAR(10) NOT NULL,
    FOREIGN KEY (MA_TK) REFERENCES TAI_KHOAN(MA_TK) ON DELETE CASCADE,
    FOREIGN KEY (MA_KHOA) REFERENCES KHOA_KHAM_BENH(MA_KHOA)
);

-- Tạo bảng Lịch Làm Việc
CREATE TABLE LICH_LAM_VIEC (
    MA_BS NVARCHAR(100) NOT NULL,
    NGAY DATE NOT NULL,
    CA_LAM_VIEC NVARCHAR(20) NOT NULL,
    PRIMARY KEY (MA_BS, NGAY, CA_LAM_VIEC),
    FOREIGN KEY (MA_BS) REFERENCES BAC_SI(MA_BS) ON DELETE CASCADE
);

-- Tạo bảng Đăng Ký Khám
CREATE TABLE DANG_KY_KHAM (
    MA_DK INT PRIMARY KEY IDENTITY(1,1),
    MA_BN NVARCHAR(100) NOT NULL,
    MA_BS NVARCHAR(100) NOT NULL,
    NGAY_DANG_KI DATE NOT NULL,
    NGAY_DEN_KHAM DATE NOT NULL,
    TRANG_THAI NVARCHAR(50) DEFAULT 'CHỜ XÁC NHẬN',
    FOREIGN KEY (MA_BN) REFERENCES BENH_NHAN(MA_BN) ON DELETE CASCADE,
    FOREIGN KEY (MA_BS) REFERENCES BAC_SI(MA_BS)
);
-------------------------------------------------------------------------

--- Data mẫu

--------------------------------------------------------------------------

-- Thêm dữ liệu vào bảng TAI_KHOAN
INSERT INTO TAI_KHOAN (TEN_DANG_NHAP, MAT_KHAU, ROLE) VALUES 
('user_benhnhan1', 'password1', 0),   -- Bệnh nhân 1
('user_benhnhan2', 'password2', 0),   -- Bệnh nhân 2
('user_bacsi1', 'password3', 2),      -- Bác sĩ 1
('user_bacsi2', 'password4', 2),      -- Bác sĩ 2
('user_quanly1', 'password5', 1);     -- Quản lý

-- Thêm dữ liệu vào bảng BAO_HIEM_Y_TE
INSERT INTO BAO_HIEM_Y_TE (MA_BHYT, GIOI_TINH, NGAY_BD, NGAY_HH, NGAY_SINH) VALUES 
('BHYT001' , 1, '2023-01-01', '2025-01-01', '1990-05-15'),
('BHYT002', 0, '2023-03-01', '2026-03-01', '1995-08-20');

-- Thêm dữ liệu vào bảng BENH_NHAN
INSERT INTO BENH_NHAN (MA_BN, MA_TK, HOTEN, SDT, EMAIL, DIA_CHI, CCCD, MA_BHYT) VALUES 
('BN001', 1, 'Nguyen Van A', '0123456789', 'nguyenvana@example.com', 'Ha Noi', '123456789', 'BHYT001'),
('BN002', 2, 'Le Thi B', '0987654321', 'lethib@example.com', 'Ho Chi Minh', '987654321', 'BHYT002');

-- Thêm dữ liệu vào bảng QUAN_LY
INSERT INTO QUAN_LY (MA_TK, TEN_QL, SDT, EMAIL) VALUES 
(5, 'Tran Van QL', '0123123123', 'quanly@example.com');

-- Thêm dữ liệu vào bảng KHOA_KHAM_BENH
INSERT INTO KHOA_KHAM_BENH (MA_KHOA, TEN_KHOA) VALUES 
('KH001', 'Khoa Nội'),
('KH002', 'Khoa Ngoại');

-- Thêm dữ liệu vào bảng BAC_SI (đã cập nhật tất cả bác sĩ có tài khoản)
INSERT INTO BAC_SI (MA_BS, TEN, MA_TK, MA_KHOA) VALUES 
('BS001', 'Dr. Nguyen Van C', 3, 'KH001'),
('BS002', 'Dr. Tran Van D', 4, 'KH002');

-- Thêm dữ liệu vào bảng LICH_LAM_VIEC
INSERT INTO LICH_LAM_VIEC (MA_BS, NGAY, CA_LAM_VIEC) VALUES 
('BS001', '2023-12-01', 'Sáng'),
('BS001', '2023-12-01', 'Chiều'),
('BS002', '2023-12-02', 'Sáng'),
('BS002', '2023-12-02', 'Chiều');

-- Thêm dữ liệu vào bảng TIN_TUC
INSERT INTO TIN_TUC (NOI_DUNG, NGAY_DANG) VALUES 
('Thông báo nghỉ lễ 30/4 và 1/5.', '2023-04-20'),
('Cập nhật lịch khám bệnh.', '2023-10-01');

-- Thêm dữ liệu vào bảng DANG_KY_KHAM
INSERT INTO DANG_KY_KHAM (MA_BN, MA_BS, NGAY_DANG_KI, NGAY_DEN_KHAM, TRANG_THAI) VALUES 
('BN001', 'BS001', '2023-11-01', '2023-12-01', 'CHỜ XÁC NHẬN'),
('BN002', 'BS002', '2023-11-02', '2023-12-02', 'ĐÃ XÁC NHẬN');
